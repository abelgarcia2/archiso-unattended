#!/bin/bash

# Installation types
readonly EXT4_UNENCRYPTED="ext4"
readonly LVM_UNENCRYPTED="lvm"
readonly LVM_ENCRYPTED="lvm_encrypted"

installation_type=$EXT4_UNENCRYPTED
encryption_key=""
root_passwd="arch"
hostname="arch"
timezone="UTC"

swap_size=$(free --giga|grep "Mem"|awk '{print $2}')G
boot_size="1G"
root_size="50G"
home_size="-"

usage() {
    echo
    echo "Usage:"
    echo "$0 DEVICE [OPTION]"
    echo
    echo "Automate basic Arch Linux installation"
    echo
    echo "Options:"
    echo "-t, --installation_type   Set the installation type (ext4, lvm, lvm_encrypted) (default: ext4)"
    echo "-e, --encryption_key      Set the encryption key for LUKS2 encrypted device"
    echo "-p, --root_passwd         Set the root password (default: arch)"
    echo "--timezone                Set the system timezone (default: UTC)"
    echo "--host, --hostname        Set the system hostname (default: arch)"
    echo "--swap                    Set the swap size, pass empty to disable swap (default: RAM size)"
    echo "--boot                    Set the boot partition size (default: 1G)"
    echo "--root                    Set the root partition size (default: 50G)"
    echo "--home                    Set the home partition size, pass - to use all free space (default: all free space)"
    echo "--help                    Display this help and exit"
    echo
    echo "Examples:"
    echo "unattended-install /dev/sda -p test --swap"
    echo "unattended-install /dev/sda --home 100G"
    echo "unattended-install /dev/sda --boot 512M --timezone Europe/Madrid"
    echo "unattended-install /dev/sda -e secret --hostname homePC"
    echo
    echo "Installation types:"
    echo "ext4                      Use ext4 formated partitions"
    echo "lvm                       Use lvm volumes"
    echo "lvm_encrypted             Use lvm volumes on LUKS2 encrypted partition"
    exit 1
}

post_install() {
    echo "Creating fstab..."
    genfstab -U /mnt >> /mnt/etc/fstab

    echo "Chroot..."
    arch-chroot /mnt /bin/bash << EOF
        echo "Setting timezone..."
        ln -sf /usr/share/zoneinfo/$timezone /etc/localtime

        echo "Setting hardware clock"
        hwclock --systohc

        sed -i "/en_US.UTF-8/s/^#//" /etc/locale.gen
        locale-gen

        echo "Setting default lang..."
        echo -e "LANG=en_US.UTF-8" > /etc/locale.conf

        echo "Setting hostname..."
        echo $hostname > /etc/hostname

        echo "Setting root password..."
        echo "root:$root_passwd" | chpasswd
EOF
}

add_lvm2_hook() {
    arch-chroot /mnt /bin/bash << EOF
        echo "Adding lvm2 hook..."
        sed -ri "s/(^HOOKS=.*)(block)(.*)(filesystems)/\1\2 lvm2 \4/" /etc/mkinitcpio.conf
EOF
}

add_encrypt_hook() {
    arch-chroot /mnt /bin/bash << EOF
        echo "Adding encrypt hook..."
        sed -ri "s/(^HOOKS=.*)(block)(.*)(lvm2)/\1\2 encrypt \4/" /etc/mkinitcpio.conf
EOF
}

regenerate_initramfs() {
    arch-chroot /mnt /bin/bash << EOF
        echo "Regenerating initramfs..."
        mkinitcpio -P
EOF
}


install_grub() {
    arch-chroot /mnt /bin/bash << EOF 
        echo "Installing and configuring GRUB..."
        pacman -S --noconfirm grub efibootmgr
        grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=ArchLinuxGRUB

        if [ "$installation_type" = "$LVM_ENCRYPTED" ]; then
            uuid=\$(blkid -t PARTLABEL=ArchLVM|awk '{print \$2}'|tr -d \")
            sed -i "s/^GRUB_CMDLINE_LINUX_DEFAULT=\"[^\"]*/& cryptdevice=\$uuid:cryptlvm/" /etc/default/grub
        fi

        if [ "$installation_type" = "$LVM_UNENCRYPTED" ] || [ "$installation_type" = "$LVM_ENCRYPTED" ]; then
            sed -i 's/^GRUB_CMDLINE_LINUX_DEFAULT="[^"]*/& root=\/dev\/ArchLinuxVG\/root/' /etc/default/grub
        fi

        grub-mkconfig -o /boot/grub/grub.cfg
EOF
}

format_partitions() {
    echo "Formatting partitions"
    mkfs.fat -F 32 $BOOT_PARTITION
    if [ -n $swap_size ]; then
        mkswap $SWAP_PARTITION
    fi
    mkfs.ext4 $ROOT_PARTITION
    mkfs.ext4 $HOME_PARTITION
}

mount_partitions() {
    mount $ROOT_PARTITION /mnt

    echo "Creating mountpoints..."
    mkdir /mnt/boot /mnt/home

    echo "Mounting partitions..."
    mount $BOOT_PARTITION /mnt/boot
    mount $HOME_PARTITION /mnt/home

    if [ -n $swap_size ]; then
        echo "Enabling swap..."
        swapon $SWAP_PARTITION
    fi
}

lvm_setup() {
    echo "Creating physical volume..."
    pvcreate $MAIN_PARTITION
    echo "Creating volume group..."
    vgcreate ArchLinuxVG $MAIN_PARTITION
    echo "Creating logical volumes..."
    if [ -n $swap_size ]; then
        lvcreate --yes -L "$swap_size" -n swap /dev/ArchLinuxVG
    fi
    lvcreate --yes -L $root_size -n root /dev/ArchLinuxVG

    if [ "$home_size" = "-" ]; then
        lvcreate --yes -l 100%FREE -n home /dev/ArchLinuxVG
    else
        lvcreate --yes -L "$home_size" -n home /dev/ArchLinuxVG
    fi
}

create_lvm_partitions() {
    echo "Wiping previous signatures..."
    wipefs --all $MAIN_DRIVE_DEVICE
    echo "Creating boot partition..."
    sfdisk \
        --wipe-partitions always \
        --backup \
        $MAIN_DRIVE_DEVICE << EOF
        label: gpt
        size=$boot_size,type=uefi,name=ArchBoot
        size=-,type=lvm,name=ArchLVM
EOF
    sleep .1
}

if [ -z "$(stat $1 2> /dev/null | grep 'block special file')" ]; then
    echo "[unattended-install] ERROR: $1 is not a valid block device"
    usage
    exit 1
fi

readonly MAIN_DRIVE_DEVICE="$1"
shift

while [[ "$#" -gt 0 ]]; do
    case $1 in
        --help|-h)
            usage
            ;;
        --installation_type|-t)
            installation_type="$2";
            shift
            ;;
        --encryption_key|-e)
            encryption_key="$2";
            shift
            ;;
        --root_passwd|-p)
            root_passwd="$2";
            if [ -z "$root_passwd" ]; then
                echo "[unattended-install] ERROR: Root password cannot be empty"
                usage
            fi
            shift
            ;;
        --timezone)
            timezone="$2";
            if [ ! -e "/usr/share/zoneinfo/$timezone" ]; then
                echo "[unattended-install] ERROR: $timezone is not a valid timezone"
                usage
            fi
            shift
            ;;
        --hostname|--host)
            hostname="$2";
            shift
            ;;
        --swap)
            swap_size="$2"
            shift
            ;;
        --boot)
            boot_size="$2"
            shift
            ;;
        --root)
            root_size="$2"
            shift
            ;;
        --home)
            home_size="$2"
            shift
            ;;
        *)
            echo "[unattended-install] ERROR: $1 is unknown parameter"
            usage
            ;;
    esac
    shift
done

if [ -z "$installation_type" ]; then
    echo "[unattended-install] ERROR: Installation type cannot be empty"
    usage
fi

if [[ "$installation_type" = "$LVM_ENCRYPTED" && -z "$encryption_key" ]]; then
    echo "[unattended-install] ERROR: Must be provide an encryption key for use encryption"
    usage
fi

echo "Running unattended archlinux installation at $(date --rfc-3339=seconds)..."

sleep 1

echo "Testing internet connection..."
if ! ping -c 1 archlinux.org > /dev/null 2>&1; then
    echo "[unattended-install] ERROR: No Internet Connection. Please check your connection and try again."
    exit 1
fi

case "$installation_type" in
    $EXT4_UNENCRYPTED)
        echo "Using unencrypted ext4 partitions"
        sleep .5

        sfdisk_cmd="label:gpt\nsize=$boot_size,type=uefi,name=ArchBoot\n"
        if [ -n "$swap_size" ]; then
            sfdisk_cmd+="size=$swap_size,type=swap,name=ArchSwap\n"
        fi
        sfdisk_cmd+="size=$root_size,type=linux,name=ArchRoot\n"
        sfdisk_cmd+="size=$home_size,type=linux,name=ArchHome"

        echo "Creating partitions..."
        echo -e "$sfdisk_cmd" | sfdisk \
            --wipe-partitions always \
            --backup \
            "$MAIN_DRIVE_DEVICE"

        sleep .1

        readonly BOOT_PARTITION="/dev/disk/by-partlabel/ArchBoot"
        readonly SWAP_PARTITION="/dev/disk/by-partlabel/ArchSwap"
        readonly ROOT_PARTITION="/dev/disk/by-partlabel/ArchRoot"
        readonly HOME_PARTITION="/dev/disk/by-partlabel/ArchHome"

        format_partitions
        mount_partitions

        echo "Installing base packages..."
        pacstrap -K /mnt base linux linux-firmware vim man-db man-pages texinfo

        post_install
        install_grub
        ;;
    $LVM_UNENCRYPTED)
        echo "Using unencrypted lvm partitions"
        sleep .5

        create_lvm_partitions

        readonly MAIN_PARTITION="/dev/disk/by-partlabel/ArchLVM"

        lvm_setup

        readonly BOOT_PARTITION="/dev/disk/by-partlabel/ArchBoot"
        readonly SWAP_PARTITION="/dev/ArchLinuxVG/swap"
        readonly ROOT_PARTITION="/dev/ArchLinuxVG/root"
        readonly HOME_PARTITION="/dev/ArchLinuxVG/home"

        format_partitions
        mount_partitions

        echo "Installing base packages..."
        pacstrap -K /mnt base linux linux-firmware vim lvm2 man-db man-pages texinfo

        post_install
        add_lvm2_hook
        regenerate_initramfs
        install_grub
        ;;
    $LVM_ENCRYPTED)
        echo "Using encrypted lvm partitions"
        sleep .5

        create_lvm_partitions

        echo "Encrypting partition..."
        echo $encryption_key | cryptsetup luksFormat /dev/disk/by-partlabel/ArchLVM
        echo "Open encrypted partition..."
        echo $encryption_key | cryptsetup open /dev/disk/by-partlabel/ArchLVM cryptlvm

        readonly MAIN_PARTITION="/dev/mapper/cryptlvm"

        lvm_setup

        readonly BOOT_PARTITION="/dev/disk/by-partlabel/ArchBoot"
        readonly SWAP_PARTITION="/dev/ArchLinuxVG/swap"
        readonly ROOT_PARTITION="/dev/ArchLinuxVG/root"
        readonly HOME_PARTITION="/dev/ArchLinuxVG/home"

        format_partitions
        mount_partitions

        echo "Installing base packages..."
        pacstrap -K /mnt base linux linux-firmware vim lvm2 man-db man-pages texinfo

        post_install
        add_lvm2_hook
        add_encrypt_hook
        regenerate_initramfs
        install_grub
        ;;
    *)
        echo "[unattended-install] ERROR: $installation_type is unknown installation type "
        usage
        ;;
esac
